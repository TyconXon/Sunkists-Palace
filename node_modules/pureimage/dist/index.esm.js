var X=(r=>(r[r.transparent=0]="transparent",r[r.aliceblue=4042850303]="aliceblue",r[r.antiquewhite=4209760255]="antiquewhite",r[r.aqua=16777215]="aqua",r[r.aquamarine=2147472639]="aquamarine",r[r.azure=4043309055]="azure",r[r.beige=4126530815]="beige",r[r.bisque=4293182719]="bisque",r[r.black=255]="black",r[r.blanchedalmond=4293643775]="blanchedalmond",r[r.blue=65535]="blue",r[r.blueviolet=2318131967]="blueviolet",r[r.brown=2771004159]="brown",r[r.burlywood=3736635391]="burlywood",r[r.cadetblue=1604231423]="cadetblue",r[r.chartreuse=2147418367]="chartreuse",r[r.chocolate=3530104575]="chocolate",r[r.coral=4286533887]="coral",r[r.cornflowerblue=1687547391]="cornflowerblue",r[r.cornsilk=4294499583]="cornsilk",r[r.crimson=3692313855]="crimson",r[r.cyan=16777215]="cyan",r[r.darkblue=35839]="darkblue",r[r.darkcyan=9145343]="darkcyan",r[r.darkgoldenrod=3095792639]="darkgoldenrod",r[r.darkgray=2846468607]="darkgray",r[r.darkgreen=6553855]="darkgreen",r[r.darkgrey=2846468607]="darkgrey",r[r.darkkhaki=3182914559]="darkkhaki",r[r.darkmagenta=2332068863]="darkmagenta",r[r.darkolivegreen=1433087999]="darkolivegreen",r[r.darkorange=4287365375]="darkorange",r[r.darkorchid=2570243327]="darkorchid",r[r.darkred=2332033279]="darkred",r[r.darksalmon=3918953215]="darksalmon",r[r.darkseagreen=2411499519]="darkseagreen",r[r.darkslateblue=1211993087]="darkslateblue",r[r.darkslategray=793726975]="darkslategray",r[r.darkslategrey=793726975]="darkslategrey",r[r.darkturquoise=13554175]="darkturquoise",r[r.darkviolet=2483082239]="darkviolet",r[r.deeppink=4279538687]="deeppink",r[r.deepskyblue=12582911]="deepskyblue",r[r.dimgray=1768516095]="dimgray",r[r.dimgrey=1768516095]="dimgrey",r[r.dodgerblue=512819199]="dodgerblue",r[r.firebrick=2988581631]="firebrick",r[r.floralwhite=4294635775]="floralwhite",r[r.forestgreen=579543807]="forestgreen",r[r.fuchsia=4278255615]="fuchsia",r[r.gainsboro=3705462015]="gainsboro",r[r.ghostwhite=4177068031]="ghostwhite",r[r.gold=4292280575]="gold",r[r.goldenrod=3668254975]="goldenrod",r[r.gray=2155905279]="gray",r[r.green=8388863]="green",r[r.greenyellow=2919182335]="greenyellow",r[r.grey=2155905279]="grey",r[r.honeydew=4043305215]="honeydew",r[r.hotpink=4285117695]="hotpink",r[r.indianred=3445382399]="indianred",r[r.indigo=1258324735]="indigo",r[r.ivory=4294963455]="ivory",r[r.khaki=4041641215]="khaki",r[r.lavender=3873897215]="lavender",r[r.lavenderblush=4293981695]="lavenderblush",r[r.lawngreen=2096890111]="lawngreen",r[r.lemonchiffon=4294626815]="lemonchiffon",r[r.lightblue=2916673279]="lightblue",r[r.lightcoral=4034953471]="lightcoral",r[r.lightcyan=3774873599]="lightcyan",r[r.lightgoldenrodyellow=4210742015]="lightgoldenrodyellow",r[r.lightgray=3553874943]="lightgray",r[r.lightgreen=2431553791]="lightgreen",r[r.lightgrey=3553874943]="lightgrey",r[r.lightpink=4290167295]="lightpink",r[r.lightsalmon=4288707327]="lightsalmon",r[r.lightseagreen=548580095]="lightseagreen",r[r.lightskyblue=2278488831]="lightskyblue",r[r.lightslategray=2005441023]="lightslategray",r[r.lightslategrey=2005441023]="lightslategrey",r[r.lightsteelblue=2965692159]="lightsteelblue",r[r.lightyellow=4294959359]="lightyellow",r[r.lime=16711935]="lime",r[r.limegreen=852308735]="limegreen",r[r.linen=4210091775]="linen",r[r.magenta=4278255615]="magenta",r[r.maroon=2147483903]="maroon",r[r.mediumaquamarine=1724754687]="mediumaquamarine",r[r.mediumblue=52735]="mediumblue",r[r.mediumorchid=3126187007]="mediumorchid",r[r.mediumpurple=2473647103]="mediumpurple",r[r.mediumseagreen=1018393087]="mediumseagreen",r[r.mediumslateblue=2070474495]="mediumslateblue",r[r.mediumspringgreen=16423679]="mediumspringgreen",r[r.mediumturquoise=1221709055]="mediumturquoise",r[r.mediumvioletred=3340076543]="mediumvioletred",r[r.midnightblue=421097727]="midnightblue",r[r.mintcream=4127193855]="mintcream",r[r.mistyrose=4293190143]="mistyrose",r[r.moccasin=4293178879]="moccasin",r[r.navajowhite=4292783615]="navajowhite",r[r.navy=33023]="navy",r[r.oldlace=4260751103]="oldlace",r[r.olive=2155872511]="olive",r[r.olivedrab=1804477439]="olivedrab",r[r.orange=4289003775]="orange",r[r.orangered=4282712319]="orangered",r[r.orchid=3664828159]="orchid",r[r.palegoldenrod=4008225535]="palegoldenrod",r[r.palegreen=2566625535]="palegreen",r[r.paleturquoise=2951671551]="paleturquoise",r[r.palevioletred=3681588223]="palevioletred",r[r.papayawhip=4293907967]="papayawhip",r[r.peachpuff=4292524543]="peachpuff",r[r.peru=3448061951]="peru",r[r.pink=4290825215]="pink",r[r.plum=3718307327]="plum",r[r.powderblue=2967529215]="powderblue",r[r.purple=2147516671]="purple",r[r.rebeccapurple=1714657791]="rebeccapurple",r[r.red=4278190335]="red",r[r.rosybrown=3163525119]="rosybrown",r[r.royalblue=1097458175]="royalblue",r[r.saddlebrown=2336560127]="saddlebrown",r[r.salmon=4202722047]="salmon",r[r.sandybrown=4104413439]="sandybrown",r[r.seagreen=780883967]="seagreen",r[r.seashell=4294307583]="seashell",r[r.sienna=2689740287]="sienna",r[r.silver=3233857791]="silver",r[r.skyblue=2278484991]="skyblue",r[r.slateblue=1784335871]="slateblue",r[r.slategray=1887473919]="slategray",r[r.slategrey=1887473919]="slategrey",r[r.snow=4294638335]="snow",r[r.springgreen=16744447]="springgreen",r[r.steelblue=1182971135]="steelblue",r[r.tan=3535047935]="tan",r[r.teal=8421631]="teal",r[r.thistle=3636451583]="thistle",r[r.tomato=4284696575]="tomato",r[r.turquoise=1088475391]="turquoise",r[r.violet=4001558271]="violet",r[r.wheat=4125012991]="wheat",r[r.white=4294967295]="white",r[r.whitesmoke=4126537215]="whitesmoke",r[r.yellow=4294902015]="yellow",r[r.yellowgreen=2597139199]="yellowgreen",r))(X||{});var B=function(s,t,e,n){return(s<<24|t<<16|e<<8|n)>>>0},K=function(s,t){return s>>>8*(3-t)&255},k=function(s){return[K(s,0),K(s,1),K(s,2),K(s,3)]};var Y=function(s){return s>>>0};var v=function(s,...t){let e=s;for(let n=0;n<t.length;n+=1)e=e|t[n];return e>>>0},Q=function(s,...t){let e=s;for(let n=0;n<t.length;n+=1)e=e&t[n];return e>>>0};var _=function(s,t){return s<<t>>>0};function $(s,t,e){return s<t?t:s>e?e:s}var nt=function(s,t,e){return s+(t-s)*e};function J(s){if(!s)return 0;if(s.indexOf("#")===0){if(s.length===4){let t=parseInt(s[1],16),e=t<<4|t,n=parseInt(s[2],16),o=n<<4|n,i=parseInt(s[3],16),a=i<<4|i,f=Y(e<<16|o<<8|a);return f=_(f,8),v(f,255)}else if(s.length===5){let t=parseInt(s[1],16),e=t<<4|t,n=parseInt(s[2],16),o=n<<4|n,i=parseInt(s[3],16),a=i<<4|i,f=parseInt(s[4],16),c=f<<4|f,u=Y(e<<16|o<<8|a);return u=_(u,8),v(u,c)}else if(s.length===7){let t=Y(parseInt(s.substring(1),16));return t=_(t,8),v(t,255)}else if(s.length===9)return Y(parseInt(s.substring(1),16))}if(s.indexOf("rgba")===0){let t=s.trim().substring(4).replace("(","").replace(")","").split(",");return B(parseInt(t[0]),parseInt(t[1]),parseInt(t[2]),Math.floor(parseFloat(t[3])*255))}if(s.indexOf("rgb")===0){let t=s.trim().substring(3).replace("(","").replace(")","").split(",");return B(parseInt(t[0]),parseInt(t[1]),parseInt(t[2]),255)}if(G.call(X,s))return X[s];throw new Error("unknown style format: "+s)}var G=Object.hasOwnProperty;function it(s,t=Uint8Array){let e=s.reduce((i,a)=>i+a.length,0);if(!s.length)return null;let n=new t(e),o=0;for(let i of s)n.set(i,o),o+=i.length;return n}var F=class{constructor(...t){if(t.length===4){this.start={},this.end={},[this.start.x,this.start.y,this.end.x,this.end.y]=t;for(let e in t)if(G.call(t,e)&&typeof t[e]!="number")throw TypeError("When passing 4 arguments, only numbers may be passed")}else if(t.length===2)[this.start,this.end]=t;else throw Error("Please pass either two Point objects, or 4 integers to the constructor")}getLength(){return Math.sqrt(Math.pow(this.start.x-this.end.x,2)+Math.pow(this.start.y-this.end.y,2))}is_invalid(){return!!(Number.isNaN(this.start.x)||Number.isNaN(this.end.x)||Number.isNaN(this.start.y)||Number.isNaN(this.end.y)||this.start.x>Number.MAX_SAFE_INTEGER||this.start.y>Number.MAX_SAFE_INTEGER||this.end.x>Number.MAX_SAFE_INTEGER||this.end.y>Number.MAX_SAFE_INTEGER)}};var b=class s{constructor(t,e){this.x=t;this.y=e}clone(){return new s(this.x,this.y)}distance(t){return Math.sqrt(Math.pow(t.x-this.x,2)+Math.pow(t.y-this.y,2))}add(t){return new s(this.x+t.x,this.y+t.y)}subtract(t){return new s(this.x-t.x,this.y-t.y)}magnitude(){return Math.sqrt(this.dotProduct(this))}dotProduct(t){return this.x*t.x+this.y*t.y}divide(t){return new s(this.x/t,this.y/t)}floor(){return new s(Math.floor(this.x),Math.floor(this.y))}round(){return new s(Math.round(this.x),Math.round(this.y))}unit(){return this.divide(this.magnitude())}rotate(t){return new s(Math.cos(t)*this.x-Math.sin(t)*this.y,Math.sin(t)*this.x+Math.cos(t)*this.y)}scale(t){return new s(this.x*t,this.y*t)}equals(t){return this.x===t.x&&this.y===t.y}},D=s=>Math.PI/180*s;function ot(s){let t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,o=Number.NEGATIVE_INFINITY;return s.forEach(i=>{t=Math.min(t,i.x),e=Math.min(e,i.y),n=Math.max(n,i.x),o=Math.max(o,i.y)}),new j(t,e,n,o)}var j=class s{constructor(t,e,n,o){this.x1=t;this.y1=e;this.x2=n;this.y2=o}contains(t){return!(t.x<this.x1||t.x>=this.x2||t.y<this.y1||t.y>=this.y2)}intersect(t){let e=Math.max(this.x1,t.x1),n=Math.max(this.y1,t.y1),o=Math.min(this.x2,t.x2),i=Math.min(this.y2,t.y2);return new s(e,n,o,i)}};import*as M from"opentype.js";var q={},O=class{constructor(t,e,n,o,i){this.binary=t,this.family=e,this.weight=n,this.style=o,this.variant=i,this.loaded=!1,this.font=null}_load(t){if(this.loaded){t&&t();return}let e=function(n,o){if(n)throw new Error("Could not load font: "+n);this.loaded=!0,this.font=o,t&&t()}.bind(this);M.load(this.binary,e)}loadSync(){if(this.loaded)return this;try{return this.font=M.loadSync(this.binary),this.loaded=!0,this}catch(t){throw new Error("Could not load font: "+t)}}load(){return this.loadPromise()}loadPromise(){return new Promise((t,e)=>{this._load(()=>t())})}};function Ft(s,t,e,n,o){return q[t]=new O(s,t,e,n,o),q[t]}var jt=q;function st(s){return q[s]||(s=Object.keys(q)[0]),q[s]}function tt(s,t,e,n,o,i,a){let f=st(s._font.family);if(!f){console.warn("Font missing",s._font);return}let c=et(s,t);(i==="end"||i==="right")&&(e=e-c.width),i==="center"&&(e=e-c.width/2),a==="top"&&(n=n+c.emHeightAscent),a==="middle"&&(n=n+c.emHeightAscent/2+c.emHeightDescent/2),a==="bottom"&&(n=n+c.emHeightDescent);let u=s._font.size;if(!f.loaded){console.warn("font not loaded yet",s._font);return}let l=f.font.getPath(t,e,n,u);s.beginPath(),l.commands.forEach(function(h){switch(h.type){case"M":s.moveTo(h.x,h.y);break;case"Q":s.quadraticCurveTo(h.x1,h.y1,h.x,h.y);break;case"L":s.lineTo(h.x,h.y);break;case"C":s.bezierCurveTo(h.x1,h.y1,h.x2,h.y2,h.x,h.y);break;case"Z":{s.closePath(),o?s.fill():s.stroke(),s.beginPath();break}}})}function et(s,t){let e=st(s._font.family);if(!e)return console.warn("WARNING. Can't find font family ",s._font),{width:10,emHeightAscent:8,emHeightDescent:2};if(!e.font)return console.warn("WARNING. Can't find font family ",s._font),{width:10,emHeightAscent:8,emHeightDescent:2};let n=s._font.size,o=e.font.stringToGlyphs(t),i=0;return o.forEach(function(a){i+=a.advanceWidth}),{width:i/e.font.unitsPerEm*n,emHeightAscent:e.font.ascender/e.font.unitsPerEm*n,emHeightDescent:e.font.descender/e.font.unitsPerEm*n}}var W=class{constructor(){this.stops=[]}addColorStop(t,e){let n=J(""+e);this.stops.push({t,color:n})}_lerpStops(t){t<0&&(t+=1),t>1&&(t-=1);let e=this.stops.slice().reverse().find(l=>l.t<=t),n=this.stops.find(l=>l.t>t);n||(n=this.stops.at(-1));let o=at(t,e.t,n.t,0,1),i=l=>k(l).map(h=>h/255),a=i(e.color),f=i(n.color),c=a.map((l,h)=>nt(l,f[h],o));return(l=>{let h=l.map(m=>m*255);return B(h[0],h[1],h[2],255)})(c)}},E=class extends W{constructor(e,n,o,i){super();this.start=new b(e,n),this.end=new b(o,i)}colorAt(e,n){let o=new b(e,n),i=this.end.subtract(this.start),a=i.magnitude();i=i.divide(a);let c=o.subtract(this.start).dotProduct(i);return c=$(c/a,0,1),this._lerpStops(c)}},A=class extends W{constructor(e,n,o,i){super();this.start=new b(e,n)}colorAt(e,n){let i=new b(e,n).distance(this.start),a=$(i/10,0,1);return this._lerpStops(a)}};function at(s,t,e,n,o){return(s-t)/(e-t)*(o-n)+n}var C=class extends W{constructor(e,n,o){super();this.angle=e,this.start=new b(n,o)}colorAt(e,n){let o=this.start.subtract(new b(e,n)),i=Math.atan2(o.y,o.x)-this.angle,a=at(i,-Math.PI,Math.PI,0,1);return this._lerpStops(a)}};var ft=[1,0,0,1,0,0],R=class s{constructor(t){this.context=t,this.matrix=[1,0,0,1,0,0],this.stack=[]}getMatrix(){return this.matrix}setMatrix(t){this.matrix=[t[0],t[1],t[2],t[3],t[4],t[5]],this.setTransform()}cloneMatrix(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]}cloneTransform(){let t=new s;return t.setMatrix(this.getMatrix()),t}identity(){this.matrix=ft,this.setTransform()}isIdentity(){for(let t=0;t<this.matrix.length;t++)if(this.matrix[t]!==ft[t])return!1;return!0}fromDomMatrix(t){return[t.a,t.b,t.c,t.d,t.e,t.f]}asDomMatrix(){return{is2D:!0,isIdentity:!1,a:this.matrix[0],b:this.matrix[1],c:this.matrix[2],d:this.matrix[3],e:this.matrix[4]}}multiply(t){let e=this.matrix[0]*t[0]+this.matrix[2]*t[1],n=this.matrix[1]*t[0]+this.matrix[3]*t[1],o=this.matrix[0]*t[2]+this.matrix[2]*t[3],i=this.matrix[1]*t[2]+this.matrix[3]*t[3],a=this.matrix[0]*t[4]+this.matrix[2]*t[5]+this.matrix[4],f=this.matrix[1]*t[4]+this.matrix[3]*t[5]+this.matrix[5];this.matrix[0]=e,this.matrix[1]=n,this.matrix[2]=o,this.matrix[3]=i,this.matrix[4]=a,this.matrix[5]=f,this.setTransform()}invert(){let t=1/(this.matrix[0]*this.matrix[3]-this.matrix[1]*this.matrix[2]),e=this.matrix[3]*t,n=-this.matrix[1]*t,o=-this.matrix[2]*t,i=this.matrix[0]*t,a=t*(this.matrix[2]*this.matrix[5]-this.matrix[3]*this.matrix[4]),f=t*(this.matrix[1]*this.matrix[4]-this.matrix[0]*this.matrix[5]);this.matrix[0]=e,this.matrix[1]=n,this.matrix[2]=o,this.matrix[3]=i,this.matrix[4]=a,this.matrix[5]=f,this.setTransform()}save(){let t=this.cloneMatrix(this.getMatrix());this.stack.push(t),this.context&&this.context.save()}restore(){if(this.stack.length>0){let t=this.stack.pop();this.setMatrix(t)}this.context&&this.context.restore()}setTransform(){this.context}translate(t,e){this.matrix[4]+=this.matrix[0]*t+this.matrix[2]*e,this.matrix[5]+=this.matrix[1]*t+this.matrix[3]*e,this.setTransform()}rotate(t){let e=Math.cos(t),n=Math.sin(t),o=this.matrix[0]*e+this.matrix[2]*n,i=this.matrix[1]*e+this.matrix[3]*n,a=this.matrix[0]*-n+this.matrix[2]*e,f=this.matrix[1]*-n+this.matrix[3]*e;this.matrix[0]=o,this.matrix[1]=i,this.matrix[2]=a,this.matrix[3]=f,this.setTransform()}scale(t,e){this.matrix[0]*=t,this.matrix[1]*=t,this.matrix[2]*=e,this.matrix[3]*=e,this.setTransform()}transformPoint(t){let e=t.x,n=t.y;return new b(e*this.matrix[0]+n*this.matrix[2]+this.matrix[4],e*this.matrix[1]+n*this.matrix[3]+this.matrix[5])}};var N=class{constructor(t){this._bitmap=t,this._fillColor=255,this._strokeColor=255,this._lineWidth=1,this._globalAlpha=1,this._transform=new R,this._font={family:"invalid",size:12},this.textAlign="start",this.textBaseline="alphabetic",this.imageSmoothingEnabled=!0,this._clip=null,this._fillStyle_text="",this._strokeStyle_text="",this.states=[]}get canvas(){return this._bitmap}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t}get globalAlpha(){return this._globalAlpha}set globalAlpha(t){this._globalAlpha=$(t,0,1)}get font(){return`${this._font.size} ${this._font.family}`}set font(t){let e=t.trim().indexOf(" ");this._font.size=parseInt(t.slice(0,e)),this._font.family=t.slice(e).trim()}get fillStyle(){return this._fillStyle_text}set fillStyle(t){t instanceof W?this._fillColor=t:(this._fillColor=J(t),this._fillStyle_text=t)}get strokeStyle(){return this._strokeStyle_text}set strokeStyle(t){t instanceof W?this._strokeStyle_text=t.toString():(this._strokeColor=J(t),this._strokeStyle_text=t)}createLinearGradient(t,e,n,o){return new E(t,e,n,o)}createRadialGradient(t,e){return new A(t,e)}createConicGradient(t,e,n){return new C(t,e,n)}save(){this.states.push({_clip:this._clip}),this._transform.save()}translate(t,e){this._transform.translate(t,e)}rotate(t){this._transform.rotate(t)}scale(t,e){this._transform.scale(t,e)}transform(...t){let e=[...t];this._transform.multiply(e)}setTransform(...t){if(this._transform.identity(),t[0].is2D){let e=this._transform.fromDomMatrix(t[0]);this._transform.multiply(e)}else this._transform.multiply([...t])}getTransform(){return this._transform.asDomMatrix()}restore(){this._transform.restore();let t=this.states.pop();t&&(this._clip=t._clip)}fillRect(t,e,n,o){if(this._transform.isIdentity()){if(typeof this._fillColor=="number"&&k(this._fillColor)[3]===255){for(let a=t;a<t+n;a++)for(let f=e;f<e+o;f++)this.pixelInsideClip(a,f)&&this._bitmap._isValidCoords(a,f)&&this._bitmap.setPixelRGBA(a,f,this._fillColor);return}for(let i=t;i<t+n;i++)for(let a=e;a<e+o;a++)this.fillPixelWithColor(i,a,this.calculateRGBA(i,a))}else{let i=this.path,a=this._closed;this.beginPath(),this.rect(t-1e-4,e-1e-4,n,o),this.closePath(),this.fill(),this.path=i,this._closed=a}}clearRect(t,e,n,o){for(let i=t;i<t+n;i++)for(let a=e;a<e+o;a++)this._bitmap._isValidCoords(t,e)&&this._bitmap.setPixelRGBA(i,a,0)}strokeRect(t,e,n,o){for(let i=t;i<t+n;i++)this.fillPixelWithColor(i,e,this.calculateRGBA_stroke(i,e)),this.fillPixelWithColor(i,e+o,this.calculateRGBA_stroke(i,e+o));for(let i=e;i<e+o;i++)this.fillPixelWithColor(t,i,this.calculateRGBA_stroke(t,i)),this.fillPixelWithColor(t+n,i,this.calculateRGBA_stroke(t+n,i))}strokePixel(t,e){if(!this.pixelInsideClip(t,e))return;let n=this.calculateRGBA_stroke(t,e),o=this._bitmap.getPixelRGBA(t,e),i=this.composite(o,n);this._bitmap.setPixelRGBA(t,e,i)}fillPixelWithColor(t,e,n){if(!this.pixelInsideClip(t,e)||!this._bitmap._isValidCoords(t,e))return;let o=n,i=this._bitmap.getPixelRGBA(t,e),a=this.composite(i,o);this._bitmap.setPixelRGBA(t,e,a)}composite(t,e){let n=k(t),o=k(e),i=o.map(l=>l/255),a=n.map(l=>l/255);i[3]=i[3]*this._globalAlpha;function f(l,h,m,x){return(l*m+h*x*(1-m))/(m+x*(1-m))}let u=i.slice(0,3).map((l,h)=>f(i[h],a[h],i[3],a[3])).map(l=>l*255);return B(u[0],u[1],u[2],Math.max(n[3],o[3]))}calculateRGBA(t,e){return this._fillColor instanceof W?this._fillColor.colorAt(t,e):this._fillColor}calculateRGBA_stroke(t,e){return this._strokeColor instanceof W?this._strokeColor.colorAt(t,e):this._strokeColor}getImageData(t,e,n,o){return this._bitmap._copySubBitmap(t,e,n,o)}putImageData(t,e,n){this._bitmap._pasteSubBitmap(t,e,n)}drawImage(t,e,n,o,i,a,f,c,u){if(typeof o>"u")return this.drawImage(t,0,0,t.width,t.height,e,n,t.width,t.height);if(typeof a>"u")return this.drawImage(t,0,0,t.width,t.height,e,n,o,i);let l=new j(e,n,e+o,n+i),h=[new b(a,f),new b(a+c,f),new b(a+c,f+u),new b(a,f+u)];h=h.map(d=>this._transform.transformPoint(d));let m=ot(h),x=new j(0,0,this._bitmap.width,this._bitmap.height);m=m.intersect(x);let y=this._transform.cloneTransform();y.invert();function p(d,w,P,I,T){return(d-w)/(P-w)*(T-I)+I}for(let d=m.x1;d<m.x2;d++)for(let w=m.y1;w<m.y2;w++){let P=new b(d,w),I=y.transformPoint(P).round();if(I=new b(p(I.x,a,a+c,e,e+o),p(I.y,f,f+u,n,n+i)),l.contains(I)&&this.pixelInsideClip(P.x,P.y)&&this._bitmap._isValidCoords(P.x,P.y)){let T=t.getPixelRGBA(I.x,I.y),U=this._bitmap.getPixelRGBA(P.x,P.y),V=this.composite(U,T);this._bitmap.setPixelRGBA(P.x,P.y,V)}}}beginPath(){this.path=[],this._closed=!1}moveTo(t,e){return this._moveTo(new b(t,e))}_moveTo(t){t=this._transform.transformPoint(t),this.pathstart=t,this.path.push(["m",t])}lineTo(t,e){return this._lineTo(new b(t,e))}_lineTo(t){this.path.push(["l",this._transform.transformPoint(t)])}quadraticCurveTo(t,e,n,o){let i=this._transform.transformPoint(new b(t,e)),a=this._transform.transformPoint(new b(n,o));this.path.push(["q",i,a])}bezierCurveTo(t,e,n,o,i,a){this._bezierCurveTo(new b(t,e),new b(n,o),new b(i,a))}_bezierCurveTo(t,e,n){t=this._transform.transformPoint(t),e=this._transform.transformPoint(e),n=this._transform.transformPoint(n),this.path.push(["b",t,e,n])}arc(t,e,n,o,i,a){function f(u){let l=t+Math.cos(u)*n,h=e+Math.sin(u)*n;return new b(l,h)}o>i&&(i+=Math.PI*2);let c=Math.PI/16;if(a){let u=i;i=o+Math.PI*2,o=u}this._moveTo(f(o));for(let u=o;u<=i;u+=c)this._lineTo(f(u));this._lineTo(f(i))}arcTo(){throw new Error("arcTo not yet supported")}rect(t,e,n,o){this.moveTo(t,e),this.lineTo(t+n,e),this.lineTo(t+n,e+o),this.lineTo(t,e+o),this.lineTo(t,e)}roundRect(t,e,n,o,i){let a={bl:0,br:0,tr:0,tl:0};typeof i>"u"&&(a={bl:0,br:0,tr:0,tl:0}),typeof i=="number"&&(a={tl:i,tr:i,br:i,bl:i}),Array.isArray(i)&&(i.length===0&&(a={bl:0,br:0,tr:0,tl:0}),i.length===1&&(a={tl:i[0],tr:i[0],br:i[0],bl:i[0]}),i.length===2&&(a={tl:i[0],tr:i[1],br:i[0],bl:i[1]}),i.length===3&&(a={tl:i[0],tr:i[1],br:i[2],bl:i[1]}),i.length===4&&(a={tl:i[0],tr:i[1],br:i[2],bl:i[3]})),this.moveTo(t+a.tl,e),this.lineTo(t+n-a.tr,e),this.quadraticCurveTo(t+n,e,t+n,e+a.tr),this.lineTo(t+n,e+o-a.br),this.quadraticCurveTo(t+n,e+o,t+n-a.br,e+o),this.lineTo(t+a.bl,e+o),this.quadraticCurveTo(t,e+o,t,e+o-a.bl),this.lineTo(t,e+a.tl),this.quadraticCurveTo(t,e,t+a.tl,e),this.lineTo(t+a.tl,e)}ellipse(){throw new Error("ellipse not yet supported")}clip(){this._clip=z(this.path)}measureText(t){return et(this,t)}closePath(){if(!this._closed){if(!this.pathstart){console.warn("missing path start");let t=this.path[0];t[0]==="l"&&(this.pathstart=t[1])}this.path.push(["l",this.pathstart]),this._closed=!0}}stroke(){let t=dt(this.path),e=pt(t,this.lineWidth/2),n=z(e),o=this.fillStyle;if(this.fillStyle=this.strokeStyle,this.imageSmoothingEnabled?this.fill_aa(n):this.fill_noaa(n),this.fillStyle=o,this.debug){this.save();let i=this.strokeStyle,a=this.lineWidth;this.strokeStyle="red",this.lineWidth=1,console.log("path is",this.path),z(this.path).forEach(f=>this.drawLine(f)),console.log("flat path is",t),z(t).forEach(f=>this.drawLine(f)),console.log("stroke path is",e),z(e).forEach(f=>this.drawLine(f)),console.log("final lines are",n),this.strokeStyle=i,this.lineWidth=a,this.restore()}}drawLine(t){if(t.is_invalid())return console.error("cannot draw line",t);this.imageSmoothingEnabled?this.drawLine_aa(t):this.drawLine_noaa(t)}drawLine_noaa(t){let e=Math.floor(t.start.x),n=Math.floor(t.start.y),o=Math.floor(t.end.x),i=Math.floor(t.end.y),a=Math.abs(o-e),f=e<o?1:-1,c=Math.abs(i-n),u=n<i?1:-1,l=(a>c?a:-c)/2;for(;this.strokePixel(e,n),!(e===o&&n===i);){let h=l;h>-a&&(l-=c,e+=f),h<c&&(l+=a,n+=u)}}drawLine_aa(t){let e=this._lineWidth,n=Math.floor(t.start.x),o=Math.floor(t.start.y),i=Math.floor(t.end.x),a=Math.floor(t.end.y),f=Math.abs(i-n),c=n<i?1:-1,u=Math.abs(a-o),l=o<a?1:-1,h=f-u,m,x,y,p=f+u===0?1:Math.sqrt(f*f+u*u),d=Q(this.calculateRGBA_stroke(n,o),4294967040),w=Q(this.calculateRGBA_stroke(n,o),255);for(e=(e+1)/2;;){let I=255-~~Math.max(0,255*(Math.abs(h-f+u)/p-e+1)),T=v(d,w*I/255);if(this.fillPixelWithColor(n,o,T),m=h,x=n,2*m>=-f){for(m+=u,y=o;m<p*e&&(a!==y||f>u);m+=f){let V=255-~~Math.max(0,255*(Math.abs(m)/p-e+1)),g=v(d,w*V/255);this.fillPixelWithColor(n,y+=l,g)}if(n===i)break;m=h,h-=u,n+=c}if(2*m<=u){for(m=f-m;m<p*e&&(i!==x||f<u);m+=u){let V=255-~~Math.max(0,255*(Math.abs(m)/p-e+1)),g=v(d,w*V/255);this.fillPixelWithColor(x+=c,o,g)}if(o===a)break;h+=f,o+=l}}}fill(){this._closed||this.closePath();let t=z(this.path);this.imageSmoothingEnabled?this.fill_aa(t):this.fill_noaa(t)}fill_aa(t){let e=ht(t),n=Math.min(e.y2+1,this._bitmap.height),o=Math.max(e.y-1,0);for(let i=n;i>=o;i--){let a=rt(t,i);for(let f=0;f<a.length;f+=2){let c=lt(a[f]),u=lt(a[f+1]),l=Math.floor(a[f]),h=Math.floor(a[f+1]);for(let m=l;m<=h;m++){let x=Q(this.calculateRGBA(m,i),4294967040),y=Q(this.calculateRGBA(m,i),255),p=this.calculateRGBA(m,i);if(m===l){let d=v(x,(1-c)*y);this.fillPixelWithColor(m,i,d);continue}if(m===h){let d=v(x,u*y);this.fillPixelWithColor(m,i,d);continue}this.fillPixelWithColor(m,i,p)}}}}fill_noaa(t){let e=ht(t),n=Math.min(e.y2+1,this._bitmap.height),o=Math.max(e.y-1,0);for(let i=n;i>=o;i--){let a=rt(t,i);for(let f=0;f<a.length;f+=2){let c=Math.floor(a[f]),u=Math.floor(a[f+1]);for(let l=c;l<=u;l++){let h=this.calculateRGBA(l,i);if(l===c){this.fillPixelWithColor(l,i,h);continue}if(l===u){this.fillPixelWithColor(l,i,h);continue}this.fillPixelWithColor(l,i,h)}}}}pixelInsideClip(t,e){return this._clip?rt(this._clip,e).filter(i=>i<t).length%2!==0:!0}fillText(t,e,n){tt(this,t,e,n,!0,this.textAlign,this.textBaseline)}strokeText(t,e,n){tt(this,t,e,n,!1,this.textAlign,this.textBaseline)}};function lt(s){return s-Math.floor(s)}function z(s){let t=[],e=null;return s.forEach(function(n){if(n[0]==="m"&&(e=n[1]),n[0]==="l"){let o=n[1];t.push(new F(e,o)),e=o}if(n[0]==="q"){let o=[e,n[1],n[2]];for(let i=0;i<1;i+=.1){let a=yt(o,i);t.push(new F(e,a)),e=a}}if(n[0]==="b"){let o=[e,n[1],n[2],n[3]];ut(o,10).forEach(i=>{t.push(new F(e,i)),e=i})}}),t}function dt(s){let t=[],e=null;return s.forEach(n=>{if(n[0]==="m"){e=n[1],t.push(["m",new b(e.x,e.y)]);return}if(n[0]==="l"){e=n[1],t.push(["l",new b(e.x,e.y)]);return}if(n[0]==="b"){let o=[e,n[1],n[2],n[3]],i=ut(o,10);for(let a=1;a<i.length;a+=2)t.push(["l",new b(i[a].x,i[a].y)]);e=n[3]}}),t}function pt(s,t){let e=[],n=[];s.forEach(a=>{a[0]==="m"&&(n.length>0&&e.push(n),n=[]),n.push(a)}),n.length>0&&e.push(n),e.forEach(a=>{a[0][0]!=="m"&&console.warn("missing a starting move command!")});let o=e.map(a=>gt(a,t)),i=[];return o.forEach(a=>a.forEach(f=>i.push(f))),i}function gt(s,t){let e=null,n=[],o=[],i=null;function a(l,h,m){l.equals(h)&&console.log("same points!",l,h);let x=l.subtract(h).unit(),y=x.rotate(D(90)),p=x.rotate(D(-90));return[y.scale(m).add(h),p.scale(m).add(h)]}let f=null;function c(l){return l<-Math.PI?l+Math.PI*2:l>+Math.PI?l-Math.PI*2:l}s.forEach(function(l,h){if(l[0]==="m"&&(e=l[1],f=l,i=e.clone(),n.push(["m",i.clone()])),l[0]==="l"){let m=e,x=l[1];if(m.equals(x))return console.warn("can't project the same paths",h,l,m,x);let y=s[h+1];if(f[0]==="m"){let g=a(x,m,t);n.push(["l",g[1]]),o.push(["l",g[0]])}if(f=l,!y){let g=a(m,x,t);n.push(["l",g[0]]),o.push(["l",g[1]]);return}let p=y[1];if(p.equals(x))return console.warn("can't project the same paths",h,l,m,x);let d=m.subtract(x),w=p.subtract(x),P=Math.atan2(d.y,d.x),I=Math.atan2(w.y,w.x),T=c(I-P),U=a(m,x,t),V=a(p,x,t);if(T<0){n.push(["l",U[0]]),n.push(["l",V[1]]);let g=t/Math.cos((Math.PI+T)/2),L=m.subtract(x).unit().rotate(T/2).scale(g).add(x);o.push(["l",L])}else{let g=t/Math.cos(-(Math.PI-T)/2);g>10&&(g=10);let L=p.subtract(x).unit().rotate(-T/2).scale(g).add(x);n.push(["l",L]),o.push(["l",U[1]]),o.push(["l",V[0]])}e=x}}),o.reverse();let u=[].concat(n).concat(o);return u.push(["l",i]),u}function yt(s,t){let e=(1-t)*(1-t)*s[0].x+2*(1-t)*t*s[1].x+t*t*s[2].x,n=(1-t)*(1-t)*s[0].y+2*(1-t)*t*s[1].y+t*t*s[2].y;return new b(e,n)}function ut(s,t){function e(n){if(wt(n)<t)return[n[0],n[3]];let o=Pt(n,.5);return e(o[0]).concat(e(o[1]))}return e(s)}function Pt(s,t){let e=s[0],n=s[1],o=s[2],i=s[3],a=Z(e,n,t),f=Z(n,o,t),c=Z(i,o,t),u=Z(a,f,t),l=Z(f,c,t),h={x:(l.x-u.x)*t+u.x,y:(l.y-u.y)*t+u.y};return[[e,a,u,h],[h,l,c,i]]}function wt(s){let t=s[0],e=s[1],n=s[2],o=s[3],i=Math.pow(3*e.x-2*t.x-o.x,2),a=Math.pow(3*e.y-2*t.y-o.y,2),f=Math.pow(3*n.x-2*o.x-t.x,2),c=Math.pow(3*n.y-2*o.y-t.y,2);return i<f&&(i=f),a<c&&(a=c),i+a}function Z(s,t,e){return{x:(t.x-s.x)*e+s.x,y:(t.y-s.y)*e+s.y}}function ht(s){let t={x:Number.MAX_VALUE,y:Number.MAX_VALUE,x2:Number.MIN_VALUE,y2:Number.MIN_VALUE};function e(n){t.x=Math.min(t.x,n.x),t.y=Math.min(t.y,n.y),t.x2=Math.max(t.x2,n.x),t.y2=Math.max(t.y2,n.y)}return s.forEach(function(n){e(n.start),e(n.end)}),t}function rt(s,t){let e=[];for(let n=0;n<s.length;n++){let o=s[n].start,i=s[n].end;if(o.y<t&&i.y>=t||i.y<t&&o.y>=t){let a=o.x+(t-o.y)/(i.y-o.y)*(i.x-o.x);e.push(a)}}return e.sort(function(n,o){return n-o})}var H=class s{constructor(t,e){this.width=Math.floor(t),this.height=Math.floor(e),this.data=new Uint8Array(t*e*4);let n=255;for(let o=0;o<e;o++)for(let i=0;i<t;i++)this.setPixelRGBA(i,o,n);this._context=new N(this)}calculateIndex(t,e){return t=Math.floor(t),e=Math.floor(e),t<0||e<0||t>=this.width||e>=this.height?0:(this.width*e+t)*4}setPixelRGBA(t,e,n){this.validate_coords(t,e);let o=this.calculateIndex(t,e),i=k(n);this.data[o+0]=i[0],this.data[o+1]=i[1],this.data[o+2]=i[2],this.data[o+3]=i[3]}setPixelRGBA_i(t,e,n,o,i,a){let f=this.calculateIndex(t,e);this.data[f+0]=n,this.data[f+1]=o,this.data[f+2]=i,this.data[f+3]=a}getPixelRGBA(t,e){this.validate_coords(t,e);let n=this.calculateIndex(t,e);return B(this.data[n+0],this.data[n+1],this.data[n+2],this.data[n+3])}getDebugPixelRGBA(t,e){let n=this.calculateIndex(t,e),o=this.width,i=this.height,a=this.data;return console.dir({i:n,width:o,height:i,data:a}),B(this.data[n+0],this.data[n+1],this.data[n+2],this.data[n+3])}getPixelRGBA_separate(t,e){let n=this.calculateIndex(t,e);return this.data.slice(n,n+4)}getContext(t){return t==="2d"?this._context:null}_copySubBitmap(t,e,n,o){let i=new s(n,o);for(let a=0;a<n;a++)for(let f=0;f<o;f++){let c=this.calculateIndex(t+a,e+f),u=i.calculateIndex(a,f);for(let l=0;l<4;l++)i.data[u+l]=this.data[c+l]}return i}_pasteSubBitmap(t,e,n){for(let o=0;o<t.width;o++)for(let i=0;i<t.height;i++){let a=this.calculateIndex(e+o,n+i),f=t.calculateIndex(o,i);for(let c=0;c<4;c++)this.data[a+c]=t.data[f+c]}}_isValidCoords(t,e){return!(t<0||e<0||t>=this.width||e>=this.height)}validate_coords(t,e){if(t<0)throw new Error(`Invalid Index: x ${t} <0`);if(e<0)throw new Error(`Invalid Index: y ${e} <0`);if(t>=this.width)throw new Error(`Invalid Index: x ${t} >= width ${this.width}`);if(e>=this.height)throw new Error(`Invalid Index: y ${e} >= height ${this.height}`)}};import*as Tt from"pngjs";import*as S from"jpeg-js";var{PNG:ct}=Tt;function ue(s,t){return new H(s,t)}function ce(s,t,e={}){return new Promise((n,o)=>{if(!G.call(s,"data")||!G.call(s,"width")||!G.call(s,"height"))return o(new TypeError("Invalid bitmap image provided"));let i=new ct({width:s.width,height:s.height,deflateLevel:e.deflateLevel||9,deflateStrategy:e.deflateStrategy||3});for(let a=0;a<s.width;a++)for(let f=0;f<s.height;f++){let c=s.getPixelRGBA(a,f),u=(f*s.width+a)*4,l=k(c);for(let h=0;h<4;h++)i.data[u+h]=l[h]}i.on("error",a=>{o(a)}).pack().pipe(t).on("finish",()=>{n()}).on("error",a=>{o(a)})})}function me(s){return new Promise((t,e)=>{s.pipe(new ct).on("parsed",function(){let n=new H(this.width,this.height);for(let o=0;o<n.data.length;o++)n.data[o]=this.data[o];t(n)}).on("error",function(n){e(n)})})}function be(s,t,e=90){return new Promise((n,o)=>{if(!G.call(s,"data")||!G.call(s,"width")||!G.call(s,"height"))return o(new TypeError("Invalid bitmap image provided"));let i={data:s.data,width:s.width,height:s.height};t.on("error",a=>o(a)),t.write(S.encode(i,e).data,()=>{t.end(),n()})})}function xe(s,t){return new Promise((e,n)=>{try{let o=[];s.on("data",i=>o.push(i)),s.on("end",()=>{let i=it(o),a=null;try{a=S.decode(i,t)}catch(c){n(c);return}let f=new H(a.width,a.height);for(let c=0;c<a.width;c++)for(let u=0;u<a.height;u++){let l=(u*a.width+c)*4;f.setPixelRGBA_i(c,u,a.data[l+0],a.data[l+1],a.data[l+2],a.data[l+3])}e(f)}),s.on("error",i=>{n(i)})}catch(o){console.log(o),n(o)}})}export{H as Bitmap,N as Context,jt as debug_list_of_fonts,xe as decodeJPEGFromStream,me as decodePNGFromStream,be as encodeJPEGToStream,ce as encodePNGToStream,ue as make,et as measureText,tt as processTextPath,Ft as registerFont};
